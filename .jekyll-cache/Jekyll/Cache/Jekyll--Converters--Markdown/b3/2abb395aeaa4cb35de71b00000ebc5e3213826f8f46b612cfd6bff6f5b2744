I"ğ<h3 id="vue-å“åº”å¼è¿‡ç¨‹çš„åŸç†">vue å“åº”å¼è¿‡ç¨‹çš„åŸç†ï¼š</h3>

<p>å½“åˆ›å»º Vue å®ä¾‹æ—¶,vue ä¼šéå† data é€‰é¡¹çš„å±æ€§,åˆ©ç”¨ Object.defineProperty ä¸ºå±æ€§æ·»åŠ  getter å’Œ setter å¯¹æ•°æ®çš„è¯»å–è¿›è¡ŒåŠ«æŒï¼ˆgetter ç”¨æ¥ä¾èµ–æ”¶é›†,setter ç”¨æ¥æ´¾å‘æ›´æ–°ï¼‰,å¹¶ä¸”åœ¨å†…éƒ¨è¿½è¸ªä¾èµ–,åœ¨å±æ€§è¢«è®¿é—®å’Œä¿®æ”¹æ—¶é€šçŸ¥å˜åŒ–ã€‚</p>

<p>æ¯ä¸ªç»„ä»¶å®ä¾‹ä¼šæœ‰ç›¸åº”çš„ watcher å®ä¾‹,ä¼šåœ¨ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­è®°å½•ä¾èµ–çš„æ‰€æœ‰æ•°æ®å±æ€§ï¼ˆè¿›è¡Œä¾èµ–æ”¶é›†,è¿˜æœ‰ computed watcher,user watcher å®ä¾‹ï¼‰,ä¹‹åä¾èµ–é¡¹è¢«æ”¹åŠ¨æ—¶,setter é€»è¾‘ä¼šé€šçŸ¥ä¾èµ–ä¸æ­¤ data çš„ watcher å®ä¾‹é‡æ–°è®¡ç®—ï¼ˆæ´¾å‘æ›´æ–°ï¼‰,ä»è€Œä½¿å®ƒå…³è”çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚</p>

<p>æ€»ç»“å°±æ˜¯: vue.js é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒ-è®¢é˜…æ¨¡å¼,é€šè¿‡ Object.defineproperty æ¥åŠ«æŒå„ä¸ªå±æ€§çš„ setter,getter,åœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…,è§¦å‘å“åº”çš„ç›‘å¬å›è°ƒ</p>

<h3 id="vue-æ ¸å¿ƒè§’è‰²æ˜¯ä¸‹é¢å‡ ä¸ª">vue æ ¸å¿ƒè§’è‰²æ˜¯ä¸‹é¢å‡ ä¸ªï¼š</h3>

<ol>
  <li>
    <p>Observerï¼ˆç›‘å¬å™¨ï¼‰ï¼šç»™å¯¹è±¡æ·»åŠ  getter å’Œ setterï¼Œç”¨äºä¾èµ–æœé›†å’Œæ´¾å‘æ›´æ–°ã€‚ä¸ä»…æ˜¯ä¸€ä¸ªæ•°æ®ç›‘å¬å™¨ï¼Œä¹Ÿæ˜¯å‘å¸ƒè€…ï¼›</p>
  </li>
  <li>
    <p>Watcherï¼ˆè®¢é˜…è€…ï¼‰ï¼šobserver æŠŠæ•°æ®è½¬å‘ç»™äº†çœŸæ­£çš„è®¢é˜…è€…â€”â€”watcher å¯¹è±¡ã€‚watcher æ¥æ”¶åˆ°æ–°çš„æ•°æ®åï¼Œä¼šå»æ›´æ–°è§†å›¾ã€‚watcher å®ä¾‹åˆ†ä¸ºæ¸²æŸ“ watcher(render watcher), computed watcher, ä¾¦å¬å™¨ user watcherã€‚ç»´æŠ¤äº†ä¸€ä¸ª depsï¼ˆç”¨äºæ”¶é›†ä¾èµ–ï¼‰çš„å®ä¾‹æ•°ç»„ã€‚äºŒæ¬¡ä¾èµ–æ”¶é›†æ—¶ï¼ŒcleanupDeps åœ¨æ¯æ¬¡æ·»åŠ å®Œæ–°çš„è®¢é˜…ï¼Œä¼šç§»é™¤æ‰æ—§çš„è®¢é˜…çš„ depsï¼›</p>
  </li>
  <li>
    <p>compileï¼ˆç¼–è¯‘å™¨ï¼‰ï¼šMVVM æ¡†æ¶ç‰¹æœ‰çš„è§’è‰²ï¼Œè´Ÿè´£å¯¹æ¯ä¸ªèŠ‚ç‚¹å…ƒç´ æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼ŒæŒ‡ä»¤çš„æ•°æ®åˆå§‹åŒ–ã€è®¢é˜…è€…çš„åˆ›å»ºè¿™äº›â€œæ‚æ´»â€ä¹Ÿå½’å®ƒç®¡ï¼›</p>
  </li>
  <li>
    <p>Depï¼šç”¨äºæ”¶é›†å½“å‰å“åº”å¼å¯¹è±¡çš„ä¾èµ–å…³ç³»ï¼Œæ¯ä¸ªå“åº”å¼å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª Dep å®ä¾‹ï¼ˆé‡Œè¾¹ subs æ˜¯ Watcher å®ä¾‹æ•°ç»„ï¼‰ï¼Œæ•°æ®å˜æ›´è§¦å‘ setter é€»è¾‘æ—¶ï¼Œé€šè¿‡ dep.notify()(éå† subsï¼Œè°ƒç”¨æ¯ä¸ª Watcher çš„ update()æ–¹æ³•)é€šçŸ¥å„ä¸ª Watcherã€‚</p>
  </li>
</ol>

<h3 id="æ ¸å¿ƒä»£ç ">æ ¸å¿ƒä»£ç </h3>

<ul>
  <li>å®ç° observer</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// éå†å¯¹è±¡
function observer(target) {
  // targetæ˜¯å¯¹è±¡ï¼Œåˆ™éå†
  if (target &amp;&amp; typeof target === 'object') {
    Object.keys(target).forEach(key =&gt; {
      defineReactive(target, key, target[key])
    })
  }
}

// ç”¨definePropertyç›‘å¬å½“å‰å±æ€§
function defineReactive(target, key, val) {
  const dep = new Dep()
  // é€’å½’
  observer(val)
  Object.defineProperty(target, key, {
    // å¯æšä¸¾
    enumerable: true,
    // ä¸å¯é…ç½®
    configurable: false,
    get: function() {
      return val
    },
    set: function(value) {
      console.log(val, value)
      val = value
    }
  })
}
</code></pre></div></div>

<ul>
  <li>å®ç° dep è®¢é˜…è€…</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Dep {
  constructor() {
    // åˆå§‹åŒ–è®¢é˜…é˜Ÿåˆ—
    this.subs = []
  }
  // å¢åŠ è®¢é˜…
  addSub(sub) {
    this.subs.push(sub)
  }
  // é€šçŸ¥è®¢é˜…è€…
  notify() {
    this.subs.forEach(sub =&gt; {
      sub.update()
    })
  }
}
</code></pre></div></div>

<p>è®¢é˜…è€… Dep é‡Œçš„ subs æ•°ç»„æ˜¯ Watcher å®ä¾‹ã€‚</p>

<ul>
  <li>å®ç° Watcher ç±»</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Watcher {
  constructor() {}
  update() {
    // æ›´æ–°è§†å›¾
  }
}
</code></pre></div></div>

<p>æ”¹å†™ defineReactive ä¸­çš„ setter æ–¹æ³•ï¼Œåœ¨ç›‘å¬å™¨é‡Œå»é€šçŸ¥è®¢é˜…è€…äº†:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ç”¨definePropertyç›‘å¬å½“å‰å±æ€§
function defineReactive(target, key, val) {
  const dep = new Dep()
  // é€’å½’
  observer(val)
  Object.defineProperty(target, key, {
    // å¯æšä¸¾
    enumerable: true,
    // ä¸å¯é…ç½®
    configurable: false,
    get: function() {
      return val
    },
    set: function(value) {
      console.log(val, value)
      dep.notify()
    }
  })
}
</code></pre></div></div>
:ET